<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Summarizer Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .card { background-color: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .input-group label { font-weight: 600; color: #1e293b; margin-bottom: 0.25rem; }
        .btn-primary { background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .log-output { min-height: 200px; max-height: 400px; overflow-y: scroll; background-color: #1e293b; color: #a1a1aa; font-family: monospace; padding: 1rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-4xl mx-auto">
        <h1 class="4xl font-bold text-gray-800 mb-6 text-center">
            Hyper-Personalized Search Agent Setup
        </h1>
        <div id="auth-status" class="text-center mb-4 text-sm font-medium">Authenticating...</div>
        <div id="user-id-display" class="text-center mb-4 text-xs text-gray-500"></div>


        <div class="card p-6 mb-8">
            <h2 class="2xl font-semibold mb-4 text-indigo-700">1. Agent Configuration</h2>
            
            <div class="input-group mb-4">
                <label for="persona">Agent Persona (Who are you?)</label>
                <textarea id="persona" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Example: You are a financial analyst specializing in emerging Indian tech startups. Your goal is to identify early investment signals.">You are a regulatory compliance officer specializing in EU and Indian AI policy. Your goal is to report only on new or proposed government rules that could impact tech companies.</textarea>
            </div>

            <div class="input-group mb-4">
                <label for="topics">Key Topics to Focus On (Comma-Separated)</label>
                <input type="text" id="topics" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="AI regulation, data privacy laws, European Union, Digital India, tech policy fines">
            </div>

            <div class="input-group mb-4">
                <label for="searchQuery">Real-Time Search Query (What do you want to analyze?)</label>
                <!-- Changed from RSS URL to a direct search query for stability -->
                <input type="text" id="searchQuery" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Latest news on Google's AI policies" value="Latest updates on EU's new Digital Services Act rules">
            </div>

            <button id="runAgentBtn" class="btn-primary w-full mt-4" disabled>
                Run Search Analyst Agent
            </button>
        </div>

        <div class="card p-6">
            <h2 class="2xl font-semibold mb-4 text-indigo-700">2. Agent Output (Real-time Log & Latest Run)</h2>
            <div id="results" class="log-output">
                Waiting for agent to run...
            </div>
            
            <h2 class="2xl font-semibold mt-8 mb-4 text-indigo-700">3. Saved Insights History</h2>
            <div id="history" class="space-y-4">
                <p class="text-gray-500">Loading saved insights...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Utility function for logging to the UI
        function log(message) {
            const resultsDiv = document.getElementById('results');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.prepend(p);
        }

        async function initFirebase() {
            log("Initializing Firebase...");
            setLogLevel('debug');
            
            if (Object.keys(firebaseConfig).length === 0) {
                log("Error: Firebase configuration is missing.");
                document.getElementById('auth-status').textContent = "Authentication Error.";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        log(`Authentication successful. User ID: ${userId}`);
                        document.getElementById('auth-status').textContent = `Authenticated.`;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        document.getElementById('runAgentBtn').disabled = false;
                        setupHistoryListener(); 
                    } else {
                        log("Attempting sign-in...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            log(`Firebase Sign-In Error: ${error.message}`);
                            document.getElementById('auth-status').textContent = "Sign-In Failed.";
                        }
                    }
                });
            } catch (error) {
                log(`Firebase Initialization Error: ${error.message}`);
                document.getElementById('auth-status').textContent = "Init Failed.";
            }
        }

        // --- Database Logic (unchanged) ---

        const INSIGHTS_COLLECTION = "summaries";

        function getCollectionRef() {
            if (!userId || !appId) return null;
            // Private data storage path: /artifacts/{appId}/users/{userId}/{your_collection_name}
            return collection(db, `artifacts/${appId}/users/${userId}/${INSIGHTS_COLLECTION}`);
        }

        async function saveInsight(insight, sourceUrl, searchSourceText) {
            const insightsRef = getCollectionRef();
            if (!insightsRef) {
                log("Error: Cannot save insight. User or App ID is missing.");
                return;
            }

            try {
                // Parse the output to extract fields (basic parsing based on expected format)
                const titleMatch = insight.match(/TITLE: (.*?)(\n|$)/i);
                const summaryMatch = insight.match(/SUMMARY: (.*?)(?=ACTION:)/is);
                const actionMatch = insight.match(/ACTION: (.*)/is);

                const dataToSave = {
                    title: titleMatch ? titleMatch[1].trim() : 'No Title Found',
                    summary: summaryMatch ? summaryMatch[1].trim() : 'No Summary Found',
                    action: actionMatch ? actionMatch[1].trim() : 'No Action Found',
                    timestamp: new Date().toISOString(),
                    sourceUrl: sourceUrl, // Now a list of sources from grounding
                    searchSourceText: searchSourceText,
                    persona: document.getElementById('persona').value.trim().substring(0, 100),
                    topics: document.getElementById('topics').value.trim().substring(0, 100)
                };

                await addDoc(insightsRef, dataToSave);
                log(`ðŸ’¾ Insight saved to Firestore.`);
            } catch (e) {
                log(`Firestore Save Error: ${e.message}`);
            }
        }

        function setupHistoryListener() {
            if (!isAuthReady || !userId) return;
            const insightsRef = getCollectionRef();
            if (!insightsRef) return;

            // Query to fetch the last 10 saved insights, ordered by timestamp (newest first)
            const q = query(insightsRef, orderBy("timestamp", "desc"), limit(10));

            onSnapshot(q, (snapshot) => {
                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = ''; // Clear existing history
                
                if (snapshot.empty) {
                    historyDiv.innerHTML = `<p class="text-gray-500">No saved insights yet. Run the agent to save your first finding!</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = new Date(data.timestamp).toLocaleString();
                    
                    const sourceLinks = data.sourceUrl && Array.isArray(data.sourceUrl) 
                        ? data.sourceUrl.map((src, index) => `<a href="${src.uri}" target="_blank" class="text-indigo-500 hover:underline" title="${src.title}">${src.title.substring(0, 30)}...</a>`).join(' | ')
                        : 'No Source Info';

                    const insightHtml = `
                        <div class="card p-4 bg-gray-50 border-l-4 border-green-500">
                            <p class="text-xs text-gray-400 mb-1">${date} | Sources: ${sourceLinks}</p>
                            <p class="font-bold text-lg text-gray-800">${data.title}</p>
                            <p class="text-sm text-gray-700 mt-2">${data.summary}</p>
                            <p class="text-sm font-semibold text-red-600 mt-2">Action: ${data.action}</p>
                            <p class="text-xs text-gray-500 mt-2 italic">Persona: ${data.persona}</p>
                            <p class="text-xs text-gray-500 mt-2 italic">Query: ${data.searchSourceText}</p>
                        </div>
                    `;
                    historyDiv.innerHTML += insightHtml;
                });

                log(`âœ… Successfully loaded ${snapshot.size} historical insights.`);
            }, (error) => {
                log(`Error listening to history: ${error.message}`);
            });
        }

        // Function to make API call with exponential backoff
        async function fetchWithBackoff(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429) { // Rate limit
                            throw new Error(`Rate limited. Retrying...`);
                        }
                        // Check if it's a transient error (e.g., 5xx)
                        if (response.status >= 500 && response.status < 600 && i < retries - 1) {
                            throw new Error(`Transient error (${response.status}). Retrying...`);
                        }
                        throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if ((error.message.includes('Transient error') || error.message.includes('Rate limited')) && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        log(`Retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error('API request failed after all retries.');
        }

        // --- NEW ORCHESTRATION: Single Call with Search Grounding ---
        async function runAgent() {
            if (!isAuthReady) {
                log("Error: Authentication not ready. Please wait.");
                return;
            }

            const persona = document.getElementById('persona').value.trim();
            const topics = document.getElementById('topics').value.trim();
            const searchQuery = document.getElementById('searchQuery').value.trim();

            if (!persona || !topics || !searchQuery) {
                log("Error: Please fill in all configuration fields.");
                return;
            }

            document.getElementById('runAgentBtn').disabled = true;
            document.getElementById('results').innerHTML = '';
            log(`Starting agent run for Search Query: "${searchQuery}"`);
            log(`Analyzing based on persona: ${persona.substring(0, 50)}...`);

            // Step 1: Construct the Master Prompt
            const masterPrompt = `
                Analyze the web search results for the query: "${searchQuery}".
                
                **Your Persona:** ${persona}
                **Your Key Topics:** ${topics}
                
                Based on the search results, determine the single most important and relevant finding.
                
                If the search results are NOT RELEVANT to the persona/topics, respond with the single word: "IRRELEVANT". 
                If it IS RELEVANT, provide a brief, professional summary in this exact format:
                
                TITLE: [Title of the single most important development]
                SUMMARY: [A concise, single paragraph summary of the key findings, grounded in the search results.]
                ACTION: [One specific action the persona should consider taking based on the development.]
            `;

            log("Executing real-time web search and analysis...");
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: masterPrompt }] }],
                tools: [{ "google_search": {} }], // Enable real-time web search grounding
                systemInstruction: {
                    parts: [{ text: "You are a professional AI agent specializing in rapid, hyper-focused analysis. Adhere strictly to the user's instructions and formatting, using only information found via Google Search." }]
                }
            };

            let finalResult = null;
            let sources = [];

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                finalResult = candidate?.content?.parts?.[0]?.text || '';
                
                // Extract grounding sources
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }
                
            } catch (error) {
                log(`Gemini API Error during Search/Analysis: ${error.message}`);
                document.getElementById('runAgentBtn').disabled = false;
                return;
            }

            // Step 2: Process and Save Result
            log("--- AI Agent Run Complete ---");

            if (finalResult.trim().toUpperCase() === 'IRRELEVANT' || !finalResult) {
                log("Result: Not relevant or no clear insight found.");
                document.getElementById('results').innerHTML = `<p class="text-yellow-500">No highly relevant insights were found based on your persona and search query.</p>`;
            } else {
                log(`âœ… Relevant finding secured.`);
                
                // Save the result with the sources
                await saveInsight(finalResult, sources, searchQuery);

                // Display the current run result
                const sourceLinks = sources.map((src, index) => `<a href="${src.uri}" target="_blank" class="text-indigo-500 hover:underline" title="${src.title}">${src.title.substring(0, 30)}...</a>`).join(' | ');

                const resultsHtml = `
                    <div class="p-4 mb-4 card border-indigo-200 border-l-4">
                        <p class="text-xs text-gray-500 mb-1">Source(s): ${sourceLinks || 'No specific sources cited.'}</p>
                        ${finalResult.replace(/\n/g, '<br>')}
                    </div>
                `;
                document.getElementById('results').innerHTML = `<p class="font-bold text-lg text-green-500 mb-4">Found 1 Relevant Insight in this run:</p>${resultsHtml}`;
            }

            document.getElementById('runAgentBtn').disabled = false;
        }

        document.getElementById('runAgentBtn').addEventListener('click', runAgent);
        
        // Start Firebase initialization
        initFirebase();
    </script>
</body>
</html>
